Project-specific notes:
=======================

File and path naming 'convention' of the source file directory:
Path: Project/Donor/(third_path_token)/Experiment_type/(tracks|peak_call)/
File: (Donor)_(third_path_token)_(Experiment_type)_(Repetition)_(peaks){0,1}.(forward|reverse|narrowPeak|broadPeak|coverage|methylation).(bb|bw)
Note: mEGAdata.experiment_type corresponds to IHEC.assay

(third_path_token) takes on a few forms, depending on the project.  Often it is sample.tissue_type or a cell_type.  Doesn't appear to be relevant to 2016 McGill IHEC DH but could have implications for matching mEGAdata.public_track to mEGAdata.experiment_type.

# TODO: Currently, all files are inserted in to DB as hg38 public_tracks.  Probably shouldn't be inserting the non-humna primate tracks at all.  Mouse tracks should be mm10 assembly.


General thoughts
----------------
What are these called: (forward|reverse|narrowPeak|broadPeak|coverage|methylation).  track_type is not a very good name (since it often means assay), but seems to be used here in public_track.track_type.

There are some repeats in here, designated by file_name containing `Rep_1` (or 2, or 3).  Something will have to be done (mark one as primary, or do we want repeats?)  This is often identified in either the public_track.raw_experiment_type or sometimes the (third_path_token) field.

Which project is the Barreiro project?


Operation
---------
Setup:
Configure MySQL for no-password access (so that run_and_log.sh can run smoothly.)
Activate scripts/scripts-venv.

Config:
Generally, work one EMC project at a time.
cd scripts/
Uncomment the project in link_public_tracks_to_datasets.py main()
Specify project name in run_and_log.sh
Specify the project wildcard in findOrphanedDatasets.sql and findUnlinkedPublicTracks.sql

Running:
./run_and_log.sh

Diagnosis:
Examine the /logs/ for the project.


EMC_Asthma
----------
(third_path_token): Unknown meaning.  Probably doesn't matter.

Datasets defined only for the following sample.private_names (and no corresponding files exist):
610_2000_748_0004_Eos
748_3001_855_3001_Eos
5x_asthma_maxIgE_Eos

All other sample.private_names don't have any datasets defined in mEGAdata.

_10x and _0.5x sometimes gets parsed away from Experiment_type, though it shouldn't be a problem.  prefix regex seems to be grabbing enough.

Appears to be some pooling going on (multiple names in the sample.private_names)
5x_asthma_maxIgE_Eos is a strange sample.private_name.
There is also a 10x in some file names that seems odd.

File_names 837_0001 might have some repeats (containing 0.5x or trailing "_2").  No data file matches, anyways.

Note the trailing "_2" and the ATACSeqCP (CoPy?)
./EMC_Asthma/837_0001/CD4_0.5x/ATACSeqCP/tracks/837_0001_CD4_0.5x_ATACSeqCP_1.bw
./EMC_Asthma/837_0001/CD4_0.5x/ATACSeqCP/peak_call/837_0001_CD4_0.5x_ATACSeqCP_1_peaks.narrowPeak.bb
./EMC_Asthma/837_0001/CD4/ATACSeq/peak_call/837_0001_CD4_ATACSeq_2_peaks.narrowPeak.bb
./EMC_Asthma/837_0001/CD4/ATACSeq/tracks/837_0001_CD4_ATACSeq_2.bw
./EMC_Asthma/837_0001/Eos_10x/ATACSeq/peak_call/837_0001_Eos_10x_ATACSeq_1_peaks.narrowPeak.bb
./EMC_Asthma/837_0001/Eos_10x/ATACSeq/tracks/837_0001_Eos_10x_ATACSeq_1.bw



EMC_BluePrint
-------------
(third_path_token): Values take the following forms: GR, H3_nTC, Mono or nTC.  nTC (no Template Control?)  So far, this is ignored.

This is a large project and wacky project (many files).
Is this related to the BluePrint that is already in the IHEC DP?  Want to avoid repeats.

Repeats possibly present.  For instance:
EMC_BluePrint/S000X1/nTC/ChIP_2_H3K4me1/peak_call/S000X1_nTC_ChIP_2_H3K4me1_1_peaks.broadPeak.bb
Going to need an explanation of the _2_, _3_, etc. that are present.  Haven't looked into them very much, so far.

Data files not detected by r"BluePrint.*(_nTC|_GR). These have "_Mono" in the file_name:
./EMC_BluePrint/S002FT/Mono/ChIP_H3K27ac/tracks/S002FT_Mono_ChIP_H3K27ac_1.bw
./EMC_BluePrint/S002FT/Mono/ChIP_H3K27ac/peak_call/S002FT_Mono_ChIP_H3K27ac_1_peaks.narrowPeak.bb
./EMC_BluePrint/S0026A/Mono/ChIP_H3K4me1/tracks/S0026A_Mono_ChIP_H3K4me1_1.bw
./EMC_BluePrint/S0026A/Mono/ChIP_H3K4me1/peak_call/S0026A_Mono_ChIP_H3K4me1_1_peaks.broadPeak.bb
./EMC_BluePrint/S0026A/Mono/ChIP_H3K27ac/tracks/S0026A_Mono_ChIP_H3K27ac_1.bw
./EMC_BluePrint/S0026A/Mono/ChIP_H3K27ac/peak_call/S0026A_Mono_ChIP_H3K27ac_1_peaks.narrowPeak.bb
./EMC_BluePrint/S002KJ/Mono/ChIP_H3K4me1/peak_call/S002KJ_Mono_ChIP_H3K4me1_1_peaks.broadPeak.bb
./EMC_BluePrint/S002KJ/Mono/ChIP_H3K4me1/tracks/S002KJ_Mono_ChIP_H3K4me1_1.bw
./EMC_BluePrint/S002KJ/Mono/ChIP_H3K27ac/peak_call/S002KJ_Mono_ChIP_H3K27ac_1_peaks.narrowPeak.bb
./EMC_BluePrint/S002KJ/Mono/ChIP_H3K27ac/tracks/S002KJ_Mono_ChIP_H3K27ac_1.bw

These file_names seem to be missing the sample names (and have nTC|GR|Mono twice in the path):
./EMC_BluePrint/nTC/nTC/ChIP_Input/tracks/nTC_ChIP_Input.bw
./EMC_BluePrint/GR/GR/ChIP_Input/tracks/GR_ChIP_Input.bw
./EMC_BluePrint/Mono/Mono/ChIP_Input/tracks/Mono_ChIP_Input.bw

nTC and GR (and Mono) mean something, possibly important.

In all withMatch.log cases (onyl 28), ChIP_H3K27ac files are getting matched to plain, old H3K27ac datasets (through find_raw_experiment_type()).  
Okay, so according to mEGAdata.experiment_type, for all the H3Kxxx types, they are equivalent to the ChIP_H3Kxxx type (ie. H3K27me3 = ChIP_H3K27me3 = Histone H3K27me3).  However, there are many repeats here (ie. no underscore, _3, _4)

mEGAdata has datasets 'mostly' for RNA-seq, MRNA-seq and Capture Methylome.  However, there aren't any data files for these experiment_types.  In general, there are raw data files, but no processed .bw or .bb for these 3 experiment_types.

There are over 1K files for ChIP_H3Kxxx, but no datasets defined in mEGAdata.  Does ChIP possibly refer to "Chipmentation" in this context (I doubt it)?  I suspect just missing defined datasets.


EMC_Bone
--------
(third_path_token): Cort_Bone or Trab_Bone.  Probably a tissue type.  Ignored.

Some of the unmapped NChIP experiment_types are here.

According to mEGAdata UI, there are donors and samples, but no datasets.  #TODO Some will probably have to be defined.


EMC_BrainBank
--------------
(third_path_token): Special.  Careful.

Some not automatically linked datasets are because there are sample names AND experiment_types in the (third_path_token).  Intervene manually for these cases.

Uh-oh.  There is some kind of 'pooling' going on here.  Not sure what it is, or whether it has implicatons for repetitions.  Most of the mEGAdata metadata (only 15 datasets exist) are matched to 'pools'.  The variable number of _'s in the sample.private_name are because these pools have different numbers of constituents.

Question: What to do with the non-pooled (single sample) analysed data?  Does it get released?  There does not appear to be any metadata exclusive to them (only have meatadata from pools).

There are data files for BA11_Brain_RNASeq (part of S133_BA11_Brain pool?). There are files for BA11_BS, but no metadata.

BA8_BA9 BS versus BA8_BA9_Brain RNASeq?

See logs/EMC_BrainBankLog_noMatch.txt for annotated details.

# Do a quick check that the linked datasets are indeed properly linked.  Done.  Yes.

(scripts-venv) assez@heap:~/projects/megadata/scripts$ grep -c "None or multiple corresponding" brainLog.txt 
106 - *** Check if these no corresponding dataset found are appropriate.***
(scripts-venv) assez@heap:~/projects/megadata/scripts$ grep -c "mapping to all of:" brainLog.txt
0
(scripts-venv) assez@heap:~/projects/megadata/scripts$ grep -c "Dataset linked" brainLog.txt
170 - Spotcheck a few.  They look good.
(scripts-venv) assez@heap:~/projects/megadata/scripts$ grep -c "No mapping experiment_type.name for" brainLog.txt 
12 - All are unmapped NChiPs. (There are more unmapped NCHiPs in other projects too.)
#TODO: Some of the unmapped NCHiP's are in this project.

Any manual pairings required?  Yes.  #TODO: And ask about the ChIP2.

Validation scripts:
1) findUnlinkedPublicTracks.sql
104 results.

2) findOrphanDatasets.sql
Going through donor_metadata.value = 'EMC_Brain%'
14 datasets orphaned. (That's a fair amount, almost 1/9th of this project.  Most of the orphans are RNA-Seq.)


EMC_Cagekid
-----------
(third_path_token): Kidney types, Normal or Tumour tissue.

Every kidney has a 'normal' sample (named N1 or N2) or a tumour (T1) sample.  This info should be present in the `additional_information` and `disease` columns of mEGAdata (though it didn't transfer to the .ods version, for some reason.)
#TODO: Should both be included in the IHEC submission?  Probably yes.

We've got both BS and BS2 tracks.  What is the diff, which should be used?  For now, they are being linked to datasets.

Dataset for R398_T2_Kidney ATAC-seq is truly an orphan (no corresponding data files.)


EMC_COPD
--------
What is this?  Only one Donor/Sample and no datasets defined.  No public_track files either.


EMC_Drouin
----------
fastq.gz files only.  Should ask about this project.  Only two samples, but they've got 16 datasets.


EMC_iPSC
--------
(third_path_token): Always 'iPS'.  Not a problem.

#TODO: add_tracks_to_db.py imported the non-human primates as assembly = 'hg38' into mEGAdata.  Should be changed.

Has 3 human donors (all are other non-human primates).  For now, including the humans only.
Only have tracks for 2 of the 3 human donors.

#TODO: Look at the structured_data directory and you'll see that the collection of files is a bit weird.

Overall, there are 103 orphaned datasets (including all species).

#PROBLEM: Only have .bw & .bb tracks for 2 human datasets (there are 29 datasets for the 2 humans in mEGAdata!)  The raw fastq.gz files exist - it looks like .bw and .bb were never generated.

Even non-human primates have fastq.gz, but there are only a few .bw & .bb.  Looks like the new .bw & .bb tracks were never generated for most non-human datasets.

#TODO: For now, not pairing the non-human primates for IHEC DH purposes (though the species do exist in the IHEC DB.)
IHEC DH doesn't seem to include species information (aside from assemlby 'other') anywhere in its generated DH.  These non-human primates are already in the IHEC DP now.  Remove them?  Should their files have even been aligned to hg38? 
What is the value of publishing non-human primates to IHEC DP if their species is never clearly specified (though there are many ~60 tracks in total)?
What to do?
Note: the raw file names of the non-human primates


EMC_Leukemia
------------
(third_path_token): Always 'PreBC' or 'PrBC'.  Not a problem.

Don't have metadata for this "Pool" track:
./EMC_Leukemia/Pool/PreBC/BS/tracks/Pool_PreBC_BS_1.coverage.bw
(What is a "Pool" anyways?)

No datasets defined in MEGAdata (despite metadata existing)
883_PrBC
898_PrBC

No metadata (or datasets) defined (despite tracks existing):
Pool_PreBC_BS_1


EMC_Mature_Adipocytes
---------------------
Donors EG011 -> EG020: No entry in the DB.  These are all ATACSeq (non-core IHEC assay, so maybe best to ignore them).  These missing donor represent about 3/8 of the EMC_Mature_Adiposytes tracks.  ATACSeq is an IHEC non-core assay.

Also, EG010 is ATACSeq, but IS present in the DB.  Manually joined.

Using hook that sample.private_name is within public_track.file_name (INsufficiently distinct).

(third_path_token): Appears to be cell types.  Ignored.

'EG006' has a typo: 'SC_Stoma'

There are some filenames ending in a trailing "_2".  Doesn't seem to affect anything since there are no corresponding "_1" filenames.


EMC_Mitochondrial_Disease
-------------------------
(third_path_token): Always Muscle.  No problem.

350 datasets linked, but there are many (86) orphan datasets.  I think this is going to require a closer look.  Every donor seems to be rather unique, no identifieable pattern.

For example, donour: MA, sample.private_name prefix: MA_Muscle
Orphans:
smRNASeq - Raw reads present, not .bw or .bb generated.
ChIP_Input - No sign of any files present (raw or processed).
ChIP_H3K9me3 - No sign of any files present (raw of processed).

For another example, donor: TB, sample.private_name prefix TB_Muscle
Orphans:
Bisulfite-seq - No files (raw or processed) present.
smRNA-seq - Raw files present, no processed files.
ChIP-Seq Input - No files (raw or processed) present.
H3K4me3 - No files (raw or processed) present.
H3K9me3 - There are some ChIP2_H3K9me3 raw files, but no .bw or .bb present.


EMC_MSCs
--------
(third_path_token): A mess.

One parsing error effecting raw_experiment_type - manually moved:
EMC_MSCs/454T/MSC_Tagmentation-ChIP_100K/H3K4ME1/peak_call/454T_MSC_Tagmentation-ChIP_100K_H3K4ME1_2_peaks.broadPeak.bb

Only 4 samples in mEGAdata with 4 datasets listed (one each), but 358 data files.  What is going on here?
Not going to do anything for this project until there is some clarification (only 4 tracks would be matched anyways to 2 datasets).

Will have to examine this project closely.


EMC_Primate
-----------
Raw fastq.gz files only, no .bw or .bb.
Are any of these human primates?  Unknown.


EMC_Rodent_Brain
----------------
fastq.gz files only.
IHEC does take mice data, after all...
No records of mice donors in DB (no metadata in mEGAdata).
#TODO: add_tracks_to_db.py imported the mice as assembly = 'hg38'.  Should be changed, at least.


EMC_SARDs
---------
SARDs = Systemic Autoimmune Rheumatic Diseases?

(third_path_token): TC or Mono.  Not important (see below).

TC = T Cell
BC = B Cell
Mono = Monocyte 
Ce sont toutes des cellules du système immunitaire.

There is a large number (and %age) of orphanDatasets (150), but very few unjustified noMatch public_tracks.  This could be related to...  Lots of fastq.gz without corresponding .bb or .bw in structured_data.

29 (of 125) sample.private_name end in 'BC', though there are zero (0) public_tracks with 'BC'.  Strange, since datasets (28 of 150) do exist.  This could be related to absent .bb & .bw (as above).

rawExperimentTypeMappingProblems (24 cases) are all for NChIP.  Need to decide how to handle these, eventually.

Looks like some kind of pooling for the following sample.private_names:
247KASP_251BRID_Mono
254FUNR_247KASP_TC
243GAGL_248GOUE_TC
247KASP_254FUNR_TC
237LAQC_243GAGL_248GOUE_TC

Multiple matches:  All from sample.private_name 243GAGL_Mono.  There are two in the DB, except one has a BS-Seq, and one doesn't. Duplicates already have EGA_EGAN values (meaning they were already submitted?).
Ahha! The time_point column (links to sample_property.property = 'time_point') is in use (sometimes) and takes the value "_1" or "_2".
All other cases of time_point "_1" and "_2" are inconsequential (since there are no data files, or no datasets defined, or BC/TC/Mono are sufficient to differentiate.)  So overall, except for 243GAGL, the time_point column doesn't cause any conflicts (multiple datasets) and doesn't really matter.

sample.private_name 243GAGL_TC is also duplicated in mEGAdata but one sample doesn't have any datasets defined.

From the noMatch.log (in order):
248GOUE_Mono_ChIP_H3K27me3a: Looks like the dataset just wasn't created, possibly by accident.
012_etc... are the NChIPs...  24 cases.
254FUNR_Mono_ChIP_H3K27ac: Again, looks like the dataset just wasn't created, possibly by accident.
247KASP_251BRID_Mono: Again, looks like the dataset just wasn't created, possibly by accident.

Observation: There are very few samples without an RNA-Seq dataset (accidental omission?).  However, no potentially corresponding public_track files are present.  Probably not an issue.


EMC_Temporal_Change
-------------------
If these are "changes over time", should all datasets be included?  If not, which one?  Was there any other dimension tested, other than change over time (such as a treatment, or some such?)

(third_path_token): TC, BC or Mono.

In this project, the time_point column is in effect (from sample_property.property = time_point).
The trailing regex"_\d.(bb|bw)" of the filename relates to time_point.

Reviewing noMatch.log:
All BF775_.*: No CM datasets defined in mEGAdata.  No CM datasets in mEGAdata at all, despite the presence of CM public_tracks.
All BF772_.*: No corresponding datasets defined in mEGAdata.
Both BCU566_.*: No CM datasets defined in mEGAdata.
BCU582_.*: Odd use of timepoints.  public_tracks use timepoints 1,  2 and 3, but mEGAdata uses only 1 and 2.  Some missing datasets as well.
Both BCU768_TC_RNASeq_2: No time_point = 2 in mEGAdata.

Alright, withought going through each and every unmatched public_track (115), the algorithm is effective.  Unmatched public_tracks are due to problems with the data.  Unmatched tracks will have to be examined on individual bases.

Strange case:  Path & filename seem to have conflicting indicators (H3K9me3 or Input - which is it?).  Check structured_data DirTree
# EMC_Temporal_Change/BCU1799/TC/H3K9me3/tracks/BCU1799_TC_ChIP_Input_1.bw
